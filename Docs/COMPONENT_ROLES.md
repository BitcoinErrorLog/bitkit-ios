# Component Roles Reference

> **Last Updated**: December 31, 2025  
> **Purpose**: Clarify the distinct roles of each component to prevent confusion

---

## Component Overview

| Component | Primary Role | Lives In |
|-----------|-------------|----------|
| **Pubky-ring** | Identity & key management | Separate app |
| **Bitkit iOS/Android** | Bitcoin/Lightning wallet with Paykit features | Main app |
| **pubky-noise** | Noise Protocol cryptographic operations | Rust crate → FFI |
| **paykit-rs** | Payment protocol (discovery, routing, proofs) | Rust crate → FFI |
| **pubky-sdk** | Homeserver storage API | Rust crate (pubky-core) |

---

## Detailed Role Breakdown

### 1. Pubky-ring (Separate App)

**What it does:**
- Holds Ed25519 master identity keypair (NEVER leaves Ring)
- Signs in/up to Pubky homeservers
- Returns homeserver sessions to requesting apps
- Derives X25519 Noise keypairs from master seed
- Signs push relay authentication requests

**What it provides to Bitkit:**
- `PubkyRingSession` (iOS) / `PubkySession` (Android): Homeserver auth credentials
- `NoiseKeypair`: X25519 keys for encrypted communication
- Ed25519 signatures for push relay auth

**Communication:** URL scheme callbacks (`pubkyring://` → `bitkit://`)

### 2. Bitkit iOS/Android (Main Wallet App)

**What it does:**
- Bitcoin and Lightning wallet operations (via LDK)
- Consumes sessions from Pubky-ring for homeserver auth
- Uses Noise Protocol for encrypted P2P payment negotiation
- Manages contacts, subscriptions, and spending limits
- Reads/writes profiles and follows to homeserver

**What it DOES NOT do:**
- Generate or store Ed25519 identity keys
- Sign homeserver authentication directly
- Expose master secrets

### 3. pubky-noise (Rust Crate)

**What it does:**
- Implements Noise Protocol Framework (IK, XX, NN patterns)
- Handles Noise handshakes and encrypted message transport
- Manages Noise session state (cryptographic state machines)
- Provides memory-safe key handling with zeroization

**What "Noise session" means:**
- A Noise session is the **cryptographic state** of an ongoing encrypted conversation
- Created during handshake, destroyed when communication ends
- Has nothing to do with homeserver authentication

**FFI:** `PubkyNoise.xcframework` / `libpubky_noise.so`

### 4. paykit-rs (Rust Crates)

**What it does:**
- Payment method discovery via Pubky directory
- Payment execution (Bitcoin/Lightning via registered executors)
- Subscription management and signing
- Receipt generation and proof verification
- Interactive payment flows over Noise channels

**Crates:**
- `paykit-lib`: Core protocol logic
- `paykit-interactive`: Noise-based payment flows
- `paykit-subscriptions`: Recurring payment management
- `paykit-mobile`: UniFFI bindings for iOS/Android

**FFI:** `PaykitMobile.xcframework` / `libpaykit_mobile.so`

### 5. pubky-sdk (Rust Crate in pubky-core)

**What it does:**
- HTTP client for Pubky homeserver API
- Session management (sign-in/sign-up/sign-out)
- Storage read/write operations
- Profile and follows management
- DNS-over-Pubky resolution

**What "homeserver session" means:**
- A homeserver session is **HTTP authentication** for storage API
- Cookie-based: `Cookie: session=<sessionSecret>`
- Used for authenticated writes to `/pub/pubky.app/...`
- Obtained from Pubky-ring, not generated by Bitkit

---

## Critical Distinction: Homeserver Session vs Noise Session

| Aspect | Homeserver Session | Noise Session |
|--------|-------------------|---------------|
| **Purpose** | Authenticate storage API calls | Encrypt P2P communication |
| **Type** | HTTP cookie/token | Cryptographic state machine |
| **Source** | Pubky-ring (via homeserver auth) | Noise handshake |
| **Storage** | Keychain, persistent | Memory, ephemeral |
| **Lifespan** | Hours/days (can refresh) | Duration of conversation |
| **Data** | `pubkey`, `sessionSecret`, `capabilities` | Symmetric keys, nonces, cipher state |
| **iOS Type** | `PubkyRingSession` | `FfiNoiseManager.session_id` |
| **Android Type** | `PubkySession` | Noise session ID (String) |

**They are NOT interchangeable. Confusing them will cause security issues.**

---

## Data Flow: Session → DirectoryService

```
User taps "Connect with Pubky-ring"
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│ PubkyRingBridge.requestSession()                                │
│   → Opens pubkyring://session?callback=bitkit://paykit-session  │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Pubky-ring App                                                  │
│   → User selects identity                                       │
│   → Ring signs in to homeserver                                 │
│   → Returns callback with session                               │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│ PubkyRingBridge handles callback                                │
│   → Parses pubkey, sessionSecret, capabilities                  │
│   → Creates PubkyRingSession (iOS) / PubkySession (Android)     │
│   → Caches in memory + persists to keychain                     │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│ PaykitManager / ViewModel                                       │
│   → Calls DirectoryService.configureWithPubkySession(session)   │  ← CRITICAL STEP
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│ DirectoryService                                                │
│   → Creates PubkyAuthenticatedStorageAdapter                    │
│   → Adapter uses Cookie: session=<sessionSecret>                │
│   → Writes now succeed to /pub/pubky.app/...                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## Pubky Storage Paths

### Profile & Contacts (pubky.app namespace)

| Path | Purpose | Auth Required |
|------|---------|---------------|
| `/pub/pubky.app/profile.json` | User profile | Write: Yes, Read: No |
| `/pub/pubky.app/follows/{pubkey}` | Follow relationship | Write: Yes, Read: No |

### Paykit Data (paykit.app namespace)

| Path | Purpose | Auth Required |
|------|---------|---------------|
| `/pub/paykit.app/v0/endpoints/{method}.json` | Payment endpoint | Write: Yes, Read: No |
| `/pub/paykit.app/v0/requests/{requestId}` | Payment request | Write: Yes, Read: No |
| `/pub/paykit.app/v0/subscriptions/{id}` | Subscription data | Write: Yes, Read: No |

---

## Common Mistakes to Avoid

### ❌ DON'T

1. **Confuse session types**
   ```swift
   // WRONG: Using noise session ID for storage auth
   let adapter = PubkyAuthenticatedStorageAdapter(sessionId: noiseSessionId, ...)
   ```

2. **Skip DirectoryService configuration**
   ```kotlin
   // WRONG: Not configuring DirectoryService after getting session
   val session = pubkyRingBridge.requestSession(context)
   // Missing: directoryService.configureWithPubkySession(session)
   ```

3. **Store Ed25519 keys in Bitkit**
   ```swift
   // WRONG: Bitkit should never hold identity private keys
   let keypair = Keypair.generate()
   ```

### ✅ DO

1. **Configure DirectoryService when session is received**
   ```swift
   let session = try await PubkyRingBridge.shared.requestSession()
   DirectoryService.shared.configureWithPubkySession(session)
   ```

2. **Use correct types consistently**
   ```kotlin
   // PubkySession = homeserver auth
   val pubkySession: PubkySession = pubkyRingBridge.requestSession(context)
   
   // Noise session = encrypted channel
   val noiseSessionId: String = noiseManager.startSession(...)
   ```

3. **Let Pubky-ring handle identity**
   ```swift
   // Correct: Request session from Ring, never generate
   let session = try await PubkyRingBridge.shared.requestSession()
   ```

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-12-31 | Initial version after session wiring fix |

